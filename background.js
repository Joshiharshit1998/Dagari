(()=>{const e={openAIApiKey:"",model:"gpt-4o-mini-realtime-preview",voice:"alloy",systemInstructions:"",temperature:.8,maxTokens:"inf",turnDetectionMode:"Normal",silenceDuration:.5,prefixPadding:.1,threshold:.5,semanticEagerness:"Medium",noiseReduction:"None",transcriptModel:"whisper-1"},o=["meet.google.com","teams.live.com","teams.microsoft.com","app.zoom.us","app.gather.town","whereby.com","discord.com","slack.com"],t=new Set;let n=null;async function r(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;try{const o=e||n||await async function(){try{return(await chrome.storage.local.get("posthog_distinct_id")).posthog_distinct_id||null}catch(e){return console.error("[Sokuji] [Background] Error getting stored distinct_id:",e),null}}();let t="https://kizuna-ai-lab.github.io/sokuji/uninstall_feedback.html";if(o){const e=new URL(t);e.searchParams.set("distinct_id",o),t=e.toString(),console.debug("[Sokuji] [Background] Updated uninstall URL with distinct_id")}else console.debug("[Sokuji] [Background] No distinct_id available, using base uninstall URL");return chrome.runtime.setUninstallURL&&(chrome.runtime.setUninstallURL(t),console.debug("[Sokuji] [Background] Uninstall feedback URL configured")),!0}catch(e){return console.error("[Sokuji] [Background] Error updating uninstall URL:",e),!1}}chrome.runtime.onInstalled.addListener((async()=>{try{(await chrome.storage.local.get("config")).config||(await chrome.storage.local.set({config:e}),console.debug("[Sokuji] [Background] Default configuration initialized")),await r()}catch(e){console.error("[Sokuji] [Background] Error initializing configuration:",e)}})),chrome.tabs.onUpdated.addListener((async(e,n,r)=>{if(n.url||"complete"===n.status)try{const n=new URL(r.url);o.some((e=>n.hostname===e||n.hostname.endsWith("."+e)))?(await chrome.sidePanel.setOptions({tabId:e,path:`fullpage.html?tabId=${e}`,enabled:!0}),console.debug("[Sokuji] [Background] Enabled Sokuji side panel for site:",n.hostname)):(await chrome.sidePanel.setOptions({tabId:e,enabled:!1}),t.has(e)&&(t.delete(e),console.debug("[Sokuji] [Background] Removed tab from side panel tracking due to URL change:",e)))}catch(e){console.error("[Sokuji] [Background] Error updating side panel for tab:",e)}})),chrome.tabs.onActivated.addListener((async e=>{try{const t=e.tabId,n=await chrome.tabs.get(t);if(!n.url)return;const r=new URL(n.url);o.some((e=>r.hostname===e||r.hostname.endsWith("."+e)))?(await chrome.sidePanel.setOptions({tabId:t,path:`fullpage.html?tabId=${t}`,enabled:!0}),console.debug("[Sokuji] [Background] Maintaining side panel for supported site:",r.hostname)):await chrome.sidePanel.setOptions({enabled:!1})}catch(e){console.error("[Sokuji] [Background] Error updating side panel for switched tab:",e)}})),chrome.tabs.onRemoved.addListener((e=>{t.has(e)&&(t.delete(e),console.debug("[Sokuji] [Background] Removed closed tab from side panel tracking:",e))})),chrome.runtime.onMessage.addListener(((o,a,s)=>{if("GET_CONFIG"===o.type)return async function(o,t){try{const n=(await chrome.storage.local.get("config")).config||e;return o?{success:!0,value:void 0!==n[o]?n[o]:t}:{success:!0,value:n}}catch(e){return console.error("[Sokuji] [Background] Error getting config:",e),{success:!1,error:e.message,value:t}}}(o.key,o.defaultValue).then(s),!0;if("SET_CONFIG"===o.type)return async function(o,t){try{const n=(await chrome.storage.local.get("config")).config||e;return n[o]=t,await chrome.storage.local.set({config:n}),{success:!0}}catch(e){return console.error("[Sokuji] [Background] Error setting config:",e),{success:!1,error:e.message}}}(o.key,o.value).then(s),!0;if("OPEN_SIDE_PANEL"===o.type)return async function(e){try{return await chrome.sidePanel.open({tabId:e}),t.add(e),console.debug("[Sokuji] [Background] Opened side panel for tab:",e),{success:!0}}catch(e){return console.error("[Sokuji] [Background] Error opening side panel:",e),{success:!1,error:e.message}}}(o.tabId).then(s),!0;if("UPDATE_UNINSTALL_URL"===o.type){const e=o.distinct_id;return e?async function(e){try{return await chrome.storage.local.set({posthog_distinct_id:e}),n=e,console.debug("[Sokuji] [Background] Stored distinct_id"),!0}catch(e){return console.error("[Sokuji] [Background] Error storing distinct_id:",e),!1}}(e).then((()=>r(e))).then((()=>{s({success:!0})})).catch((e=>{console.error("[Sokuji] [Background] Error handling distinct_id update:",e),s({success:!1,error:e.message})})):r().then((()=>{s({success:!0})})).catch((e=>{console.error("[Sokuji] [Background] Error updating uninstall URL:",e),s({success:!1,error:e.message})})),!0}}))})();